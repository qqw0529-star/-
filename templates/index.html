<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>長照積分審查小幫手</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <img src="/static/logo.svg" alt="logo" height="60">
    <h1>🔰 小卡積分審查系統 <small>Care Points Helper</small></h1>
  </header>

  <nav class="sub-nav">
    <a href="#calculator-section" class="active">積分試算</a>
    <a href="#qa-section">常見問答 (Q&A)</a>
    <a href="#links-section">相關連結</a>
  </nav>

  <div class="disclaimer-notice">
      <p>注意：本工具僅供試算參考，最終審核結果請以主管機關認定為準。</p>
      <p>
          <a href="https://line.me/R/ti/p/@458tgyzb" target="_blank" rel="noopener noreferrer" class="report-link">!!系統錯誤回報!! (點此加入LINE好友回報)</a>
      </p>
  </div>


  <main>
    <div id="calculator-section">
        <section id="input-section">
          <h2>輸入積分資料</h2>
          <div class="input-group"> <label for="start_minguo">小卡生效日期（民國 YYY-MM-DD）：</label> <input type="text" id="start_minguo" placeholder="例如：112-06-02"> <button onclick="calculateDates()">計算效期</button> <div id="date-display" class="date-info"> </div> </div>
          <fieldset> <legend>主要積分</legend> <div class="input-item"> <label for="prof_course">▶ 專業課程積分：</label> <input type="number" id="prof_course" value="0" min="0"> </div> <div class="input-item"> <label for="qer_quality">▶ 專業品質積分：</label> <input type="number" id="qer_quality" value="0" min="0"> </div> <div class="input-item"> <label for="qer_ethics">▶ 專業倫理積分：</label> <input type="number" id="qer_ethics" value="0" min="0"> </div> <div class="input-item"> <label for="qer_regulation">▶ 專業法規積分：</label> <input type="number" id="qer_regulation" value="0" min="0"> </div> </fieldset>
          <fieldset> <legend>四大必修</legend> <div class="input-item"> <label for="mand_fire">▶ 消防安全積分：</label> <input type="number" id="mand_fire" value="0" min="0"> </div> <div class="input-item"> <label for="mand_er">▶ 緊急應變積分：</label> <input type="number" id="mand_er" value="0" min="0"> </div> <div class="input-item"> <label for="mand_inf">▶ 感染管制積分：</label> <input type="number" id="mand_inf" value="0" min="0"> </div> <div class="input-item"> <label for="mand_gen">▶ 性別敏感度積分：</label> <input type="number" id="mand_gen" value="0" min="0"> </div> </fieldset>
          <fieldset> <legend>原住民與多元文化積分</legend> <div class="input-item"> <label for="pre_change_cultural">▶ 112-06-02 前取得之文化積分總分：</label> <input type="number" id="pre_change_cultural" value="0" min="0"> <small>此部分最高採計 2 分</small> </div> <p>請輸入**小卡生效後**，各年度的原住民族文化 & 多元族群文化積分（112-06-03 起，每年各需 1 分）</p> <div id="yearly-cultural-inputs"> <p style="color: grey;">請先輸入小卡生效日期並點擊「計算效期」</p> </div> </fieldset>
          <fieldset> <legend>網路學習積分</legend> <div class="input-item"> <label for="online_points">▶ 網路學習積分總數：</label> <input type="number" id="online_points" value="0" min="0"> <small>所有課程中來自網路學習的積分加總，上限 40 分</small> </div> </fieldset>
          <button onclick="submitEvaluation()">🔍 送出審查</button>
        </section>
    </div>

    <section id="result-section" style="display: none;"> <h2>🔍 審查結果：</h2> <div id="result-details"></div> <pre id="raw-result" style="display:none;"></pre> </section>

    <div class="qa-container" id="qa-section"> <section> <h2>積分規定 常見問答 (Q&A)</h2> <p>資料來源：長期照顧服務人員訓練認證繼續教育及登錄辦法問答集 (113.2.6版) 及 積分審查教育訓練簡報 (113.8.23版)。</p>
        <details> <summary>Q: 取得長照人員認證(長照小卡)前上過的課，可以算積分嗎？</summary> <div class="answer"> <p><strong>A:</strong> 不行。</p> <p>根據辦法第9條，長照人員應自「認證證明文件生效日起」，每6年接受繼續教育課程。 因此，在長照小卡生效日之前取得的課程積分，不予採認。</p> </div> </details>
        <details> <summary>Q: Level I (長照共同訓練課程) 可以算是繼續教育積分嗎？</summary> <div class="answer"> <p><strong>A:</strong> 不行。</p> <p>Level I 屬於成為長照人員前的「資格訓練課程」。 「繼續教育積分」是指取得長照人員服務證明(長照小卡) *之後* 所上的課程。兩者目的不同，因此資格訓練課程不能算是繼續教育積分。</p> </div> </details>
        <details> <summary>Q: 長照小卡更新需要哪些積分？必修課程有哪些？</summary> <div class="answer"> <p><strong>A:</strong> 認證效期6年內，積分應符合以下所有條件：</p> <ul> <li><strong>總積分：</strong> 合計至少 <strong>120 點</strong>。</li> <li><strong>課程屬性 (A+B)：</strong> <ul> <li><strong>專業課程 (A)：</strong> 至少 <strong>84 點</strong>。</li> <li><strong>專業品質、專業倫理、專業法規 (B)：</strong> 這三項合計至少 <strong>24 點</strong>，且三項都*不可為 0*。 (上限為 36 點)。</li> </ul> </li> <li><strong>四大必修 (C)：</strong> <ul> <li>消防安全、緊急應變、感染管制、性別敏感度。</li> <li>這四項合計至少 <strong>10 點</strong>，且四項都*不可為 0*。</li> </ul> </li> <li><strong>文化必修 (D)：</strong> 請參考下一題，此項有新舊制分別。</li> <li><strong>實體/網路：</strong> <ul> <li><strong>網路課程 (線上)：</strong> 積分採計上限為 <strong>40 點</strong>。</li> <li><strong>實體課程：</strong> 積分至少應達 <strong>80 點</strong> (總分120 - 網路40 = 實體80)。</li> </ul> </li> </ul> </div> </details>
        {/* 其他 Q&A Details */}
         <details> <summary>Q:「原住民族」與「多元族群」課程的積分如何計算？ (新舊制)</summary> <div class="answer"> <p><strong>A:</strong> 這是最關鍵的規則，以您的「長照小卡有效期限」或「認證更新日」在哪個區間為準：</p> <ul> <li><strong>舊制 (認證有效期限在 113年6月2日 以前)：</strong><br> 修習「原住民族與多元族群文化敏感度及能力」課程 (原名稱「多元族群文化」)，合計至少 <strong>2 點</strong> 即可。</li> <li><strong>新制 (認證有效期限在 113年6月3日 以後)：</strong><br> 必須*每年*修習「原住民族文化敏感度及能力」課程至少 <strong>1 點</strong>，*並且*「多元族群文化敏感度及能力」課程至少 <strong>1 點</strong>。 (6年合計12點)。</li> </ul> <p><strong>關鍵：</strong> 判斷新舊制的日期，是以您「長照小卡上記載的有效期限」為主，*不是*看您送出申請的日期。</p> </div> </details> <details> <summary>Q: (新制) 如果我第一年就把文化積分 12 點都上完了，之後可以不用上了嗎？</summary> <div class="answer"> <p><strong>A:</strong> 不行。 法規規定是「每年各1點為原則」。 即使前一年度已取得超過 1 點，按法令規定，下年度該課程仍應再學習。 這是為了確保文化敏感度是持續累積內化的。</p> </div> </details> <details> <summary>Q: (新制) 每年都要修文化敏感度課程嗎？如果有一年忘記修怎麼辦？</summary> <div class="answer"> <p><strong>A:</strong> 依規定，在新制 लागू होने के बाद (जिनकी कार्ड वैधता अवधि 113年6月3日 के बाद समाप्त होती है), आपको हर साल "आदिवासी" और "बहुसांस्कृतिक" संवेदनशीलता पाठ्यक्रम दोनों में से प्रत्येक में کم से कम 1 अंक प्राप्त करना होगा (कुल 2 अंक प्रति वर्ष)।</p> <p>如果您在 6 年有效期內的某一年忘記修習，您將**無法在有效期限屆滿前**完成更新。但不用太擔心，您仍然可以透過「**逾期更新**」的方式來補救。</p> <p>逾期更新時，積分計算方式會改變：</p> <ul> <li>政府會從您**提出申請更新的那一天**往前推算 6 年，來計算您這段期間的積分是否符合所有規定（包括總分 120 點、所有必修項目，以及補齊每年應有的文化積分）。</li> </ul> <p><strong>舉例：</strong></p> <ul> <li>假設小卡效期是 113年7月1日 ~ 119年6月30日 (適用新制)。</li> <li>您在第 3 年 (115.7.1 ~ 116.6.30) 忘記修文化積分。</li> <li>您無法在 119年6月30日 前更新。</li> <li>您在 119年8月1日 才提出更新申請。</li> <li>政府會審核您在 **113年8月1日 ~ 119年7月31日** (申請日往前推6年) 這段期間的積分： <ul> <li>總積分是否達 120 點？</li> <li>所有必修是否符合規定？</li> <li><strong>文化積分：</strong>這 6 年內，每年是否都有原住民 1 分 + 多元文化 1 分？(您需要在 119.7.31 前補上第 3 年漏掉的積分)。</li> </ul> </li> </ul> <p>👉 所以，就算中間有漏掉，還是有機會**事後補課**，只是會變成「逾期更新」，新的證照效期也會從更新通過日才開始計算。</p> </div> </details> <details> <summary>Q: 我的長照小卡過期了才申請更新，積分和效期如何計算？</summary> <div class="answer"> <p><strong>A:</strong> 仍可更新，但規則不同：</p> <ul> <li><strong>積分計算：</strong> 以您 "**提出申請更新日**" 往前推算 6 年内，必須完成 120 點積分 (且符合所有必修規定，包含每年文化積分)。</li> <li><strong>新效期計算：</strong> 新的長照小卡效期，是從 "**申請更新且審核通過**" 的日期開始往後計算 6 年。</li> <li><strong>積分歸零：</strong> 積分會從新的生效日起重新歸零起算。(舊卡效期內多修的積分不會保留)</li> </ul> <p><strong>舉例：</strong></p> <ul> <li>小卡效期：106年6月3日 ~ 112年6月2日。</li> <li>申請更新日：115年4月1日。</li> <li>積分採計期間：<strong>109年4月1日 ~ 115年3月31日</strong> (這段期間需滿 120 點及所有必修)。</li> <li>109年3月以前的積分不算。</li> <li>若審核通過，新卡效期：115年4月1日 ~ 121年3月31日。</li> </ul> <p>🔔 <strong>兩個小叮嚀：</strong></p> <ul> <li>⏰ 不要拖到小卡快過期才去申請更新，以免因為積分不足或資料不齊而導致證照失效。</li> <li>✍️ 逾期更新會導致積分計算範圍改變，可能讓您在舊卡效期早期修的積分失效。</li> </ul> </div> </details> <details> <summary>Q: 小卡效期內沒上滿 120 點積分，過期了還能申請更新嗎？</summary> <div class="answer"> <p><strong>A:</strong> 可以！處理方式與上一題「小卡過期後申請更新」完全相同。</p> <p>重點在於，一旦您的長照小卡**已過期**，無論您之前積分是否足夠，都適用「逾期更新」的規則：</p> <ul> <li>積分計算：看您**申請更新當天往前推 6 年**的積分。</li> <li>新卡效期：從**審核通過日**起算 6 年。</li> </ul> <p>👉 只要您在申請更新時，能提出「申請當天往前推 6 年內」已完成 120 點 (含所有必修) 的證明，就可以成功更新。</p> </div> </details> <details> <summary>Q:「直播」或「視訊」課程，算是「實體」還是「網路」積分？</summary> <div class="answer"> <p><strong>A:</strong> 視為「實體課程」。</p> <p>自 112年10月13日 起，課程以線上同步方式 (例如直播、視訊) 辦理者，視為「實體課程」積分。</p> <p>(網路課程是指那些 "事前預錄好"，可隨時上網學習的課程)。</p> </div> </details> <details> <summary>Q: 我同時有「照服員」和「居服督導」兩張長照小卡，積分可以共用嗎？</summary> <div class="answer"> <p><strong>A:</strong> 可以，但有條件。</p> <p>如果繼續教育積分的「完成時間」，同時落在每張認證證明文件的「有效期間」之內，該積分可在各張認證證明文件上均被計算。</p> <p><strong>注意：</strong> 雖然積分可共用，但更新時，您只能「擇一」*實際有在提供服務*的證明文件申請更新。</p> </div> </details> <details> <summary>Q: 我目前沒有在長照機構工作了，還可以累積積分嗎？</summary> <div class="answer"> <p><strong>A:</strong> 可以！</p> <p>繼續教育積分是跟著您的**個人長照小卡 (認證證明文件)**，而不是跟著您的工作機構。</p> <p>只要您的長照小卡仍在有效期內，即使您目前待業、轉職或從事非長照相關工作，您仍然可以參加長照繼續教育課程並累積積分。這些積分會記錄在您的個人名下，未來若要重新投入長照服務並申請更新認證時可以使用。</p> </div> </details> </section> </div>

    <section id="links-section">
        <h2>相關連結</h2>
        <ul> <li><a href="https://ltc-learning.org/mooc/index.php" target="_blank" rel="noopener noreferrer">長期照顧學習平台 (免費線上課程)</a></li> <li><a href="https://ltcpap.mohw.gov.tw/molc/eg999/index" target="_blank" rel="noopener noreferrer">衛生福利部長照機構暨長照人員相關管理資訊系統 (官方積分查詢)</a></li> <li><a href="https://1966.gov.tw/LTC/cp-6708-77733-207.html" target="_blank" rel="noopener noreferrer">各縣市辦理長照人員認證、補/換發、更新認證申請聯絡資訊</a></li> </ul>
        <p><strong>網路積分注意事項</strong>：<br> 依112年10月11日修正公布之辦法附件二規定，自112年10月13日起，參加**網路課程** (指非同步、預錄課程) 取得之積分，於申請更新認證時，**合計採計上限為 40 點**。</p>
    </section>

  </main>

  <script>
    // --- Helper Functions ---
    function getNum(id) { const el = document.getElementById(id); if (!el) { console.warn(`Element with ID ${id} not found.`); return 0; } const val = parseFloat(el.value); return isNaN(val) ? 0 : val; }
    function minguoToGregorian(minguoStr) { if (!minguoStr || !/^\d{3}-\d{1,2}-\d{1,2}$/.test(minguoStr)) return null; try { const parts = minguoStr.split('-'); const year = parseInt(parts[0], 10) + 1911; const month = parseInt(parts[1], 10); const day = parseInt(parts[2], 10); if (month < 1 || month > 12 || day < 1 || day > 31) return null; const date = new Date(year, month - 1, day); if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) { return null; } return date; } catch (e) { console.error("Date conversion error:", e); return null; } }
    function gregorianToMinguo(date) { if (!date) return ""; const year = date.getFullYear() - 1911; const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
    function addYears(date, years) { const newDate = new Date(date); newDate.setFullYear(newDate.getFullYear() + years); return newDate; }
    function subtractMonths(date, months) { const newDate = new Date(date); const originalDay = date.getDate(); newDate.setMonth(newDate.getMonth() - months); if (newDate.getDate() !== originalDay) { newDate.setDate(0); } return newDate; }
    function subtractDays(date, days) { const newDate = new Date(date); newDate.setDate(newDate.getDate() - days); return newDate; }
    // --- Core Functions ---
    let validityPeriods = []; const RULE_CHANGE_DATE_MINGUO = "112-06-02"; const RULE_CHANGE_DATE = minguoToGregorian(RULE_CHANGE_DATE_MINGUO);
    async function calculateDates() { const startMinguo = document.getElementById('start_minguo').value; const startDate = minguoToGregorian(startMinguo); const displayDiv = document.getElementById('date-display'); const yearlyInputsDiv = document.getElementById('yearly-cultural-inputs'); validityPeriods = []; if (!startDate) { displayDiv.innerHTML = "<p style='color: red;'>日期格式錯誤，請使用 YYY-MM-DD</p>"; yearlyInputsDiv.innerHTML = '<p style="color: grey;">請先輸入有效的生效日期</p>'; return; } const expiryDate = addYears(startDate, 6); const renewalStartDate = subtractMonths(expiryDate, 6); const expiryDateMinusOneDay = subtractDays(expiryDate, 1); const startDateFormatted = gregorianToMinguo(startDate); const expiryDateFormatted = gregorianToMinguo(expiryDateMinusOneDay); const renewalStartFormatted = gregorianToMinguo(renewalStartDate); displayDiv.innerHTML = ` <p>📅 有效期限：${startDateFormatted} ~ ${expiryDateFormatted}</p> <p>📌 可換證日：${renewalStartFormatted} 起</p> <hr> <p><strong>溫馨提示：</strong>因政府作業需工作天，建議於<strong>可換證日後儘早換證</strong>，避免逾期影響資格。</p> <p><small><strong>法規提醒：</strong>依《長照服務法》第58條，證照逾期未更新仍提供服務，可處 NT$3,000 ~ NT$15,000 罰鍰。(若逾期後未提供服務則無影響)</small></p> `; yearlyInputsDiv.innerHTML = ''; for (let i = 0; i < 6; i++) { const yearStartDate = addYears(startDate, i); const yearEndDate = subtractDays(addYears(startDate, i + 1), 1); const period = { year: i + 1, start: yearStartDate, end: yearEndDate, startMinguo: gregorianToMinguo(yearStartDate), endMinguo: gregorianToMinguo(yearEndDate) }; validityPeriods.push(period); const isPostChangePeriodStart = period.start >= RULE_CHANGE_DATE; const requiredText = isPostChangePeriodStart ? "（此年度起，每年各需 1 分）" : "（⚠ 此年度積分計入上方 112-06-02 前總分，最多計算2分）"; const defaultValue = 0; const yearDiv = document.createElement('div'); yearDiv.classList.add('yearly-input-group'); yearDiv.innerHTML = ` <h4>第${period.year}年：${period.startMinguo} ~ ${period.endMinguo} <small>${requiredText}</small></h4> <div class="input-item yearly-item"> <label for="year_${period.year}_ind">▶ 原住民族文化積分：</label> <input type="number" id="year_${period.year}_ind" value="${defaultValue}" min="0"> </div> <div class="input-item yearly-item"> <label for="year_${period.year}_mul">▶ 多元族群文化積分：</label> <input type="number" id="year_${period.year}_mul" value="${defaultValue}" min="0"> </div> `; yearlyInputsDiv.appendChild(yearDiv); } }
    async function submitEvaluation() { console.log("submitEvaluation function called."); const startDate = minguoToGregorian(document.getElementById('start_minguo').value); if (!startDate || validityPeriods.length !== 6) { alert("請先輸入有效的小卡生效日期並點擊「計算效期」。"); console.error("Evaluation aborted: Start date invalid or validity periods not calculated."); return; } let yearlyCulturalPoints = []; try { yearlyCulturalPoints = validityPeriods.map(period => { const indId = `year_${period.year}_ind`; const mulId = `year_${period.year}_mul`; return { year: period.year, indigenous: getNum(indId), multicultural: getNum(mulId) }; }); } catch (e) { console.error("Error collecting yearly cultural points:", e); alert("讀取年度文化積分時發生錯誤，請檢查輸入欄位。"); return; } const payload = { professional_course: getNum('prof_course'), quality_ethics_regulation: getNum('qer_quality') + getNum('qer_ethics') + getNum('qer_regulation'), quality_points_raw: getNum('qer_quality'), ethics_points_raw: getNum('qer_ethics'), regulation_points_raw: getNum('qer_regulation'), mandatory: { fire_safety: getNum('mand_fire'), emergency_response: getNum('mand_er'), infection_control: getNum('mand_inf'), gender_sensitivity: getNum('mand_gen') }, pre_change_cultural_points: getNum('pre_change_cultural'), yearly_cultural_points: yearlyCulturalPoints, renewal_date: gregorianToMinguo(subtractDays(addYears(startDate, 6), 1)), online_points: getNum('online_points') }; payload.fire_safety_raw = payload.mandatory.fire_safety; payload.emergency_response_raw = payload.mandatory.emergency_response; payload.infection_control_raw = payload.mandatory.infection_control; payload.gender_sensitivity_raw = payload.mandatory.gender_sensitivity; console.log("Payload to be sent:", JSON.stringify(payload, null, 2)); const resultSection = document.getElementById('result-section'); const resultDetailsDiv = document.getElementById('result-details'); const rawResultPre = document.getElementById('raw-result'); resultDetailsDiv.innerHTML = '<p>計算中...</p>'; resultSection.style.display = 'block'; try { const res = await fetch('/api/evaluate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); console.log("API Response Status:", res.status); const data = await res.json(); console.log("Data received from API:", data); rawResultPre.textContent = JSON.stringify(data, null, 2); if (res.ok) { console.log("Calling displayResults..."); displayResults(payload, data); } else { console.error("API Error:", data.error); resultDetailsDiv.innerHTML = `<p style="color: red;">審查失敗: ${data.error || '未知錯誤'}</p>`; } } catch (e) { console.error("Fetch Error:", e); resultDetailsDiv.innerHTML = `<p style="color: red;">連線或處理錯誤: ${e.message}</p>`; resultSection.style.display = 'block'; } }
    // --- Display Function ---
    function displayResults(inputs, results) { console.log("Displaying results. Inputs:", inputs, "Results:", results); const detailsDiv = document.getElementById('result-details'); if (!detailsDiv) { console.error("Result details div not found!"); return; } let html = '<ol>'; if (!results || !results.passes || !results.breakdown) { console.error("Invalid results structure received from backend:", results); detailsDiv.innerHTML = '<p style="color: red;">收到無效的回應資料，無法顯示結果。</p>'; return; } const rules = { min_total_points: 120, min_professional_course: 84, min_qer_total: 24, max_qer_total: 36, min_mandatory_total: 10, min_fire: 1, min_er: 1, min_inf: 1, min_gen: 1, cultural_change_date: RULE_CHANGE_DATE_MINGUO, cultural_before_min: 2, cultural_before_max: 2, cultural_after_yearly_min: 1, cultural_after_total_min: 12, max_online_points: 40, min_physical_points: 80 }; const profPoints = inputs.professional_course; const profPass = results.passes.professional_min; html += `<li>專業課程積分：${profPoints.toFixed(1)} ${profPass ? '✅' : '❌'}`; if (!profPass) { html += `<br><span class="error-reason">【缺少積分】需達到 ${rules.min_professional_course} 分，您目前缺少 ${(rules.min_professional_course - profPoints).toFixed(1)} 分。</span>`; } html += `</li>`; const qerRawTotal = inputs.quality_points_raw + inputs.ethics_points_raw + inputs.regulation_points_raw; const qerCounted = results.breakdown.quality_ethics_regulation.counted; const qerPassMin = results.passes.qer_min; const qerPassEachNonZero = results.passes.qer_each_non_zero; const qerPass = qerPassMin && qerPassEachNonZero; html += `<li>品質/倫理/法規積分：${qerRawTotal.toFixed(1)}（計入 ${qerCounted.toFixed(1)}，上限 ${rules.max_qer_total}） ${qerPass ? '✅' : '❌'}`; if (!qerPassMin) { html += `<br><span class="error-reason">【缺少積分】合計需達到 ${rules.min_qer_total} 分，您目前缺少 ${(rules.min_qer_total - qerCounted).toFixed(1)} 分。</span>`; } if (!qerPassEachNonZero) { let missingCats = []; if (inputs.quality_points_raw <= 0) missingCats.push("品質"); if (inputs.ethics_points_raw <= 0) missingCats.push("倫理"); if (inputs.regulation_points_raw <= 0) missingCats.push("法規"); html += `<br><span class="error-reason">【缺少類別】${missingCats.join('、')} 不可為 0 分。</span>`; } html += `</li>`; const mandatoryItems = [ { id: 'fire', name: '消防安全', key: 'fire_safety', min: rules.min_fire, passKey: 'mandatory_fire' }, { id: 'er', name: '緊急應變', key: 'emergency_response', min: rules.min_er, passKey: 'mandatory_er' }, { id: 'inf', name: '感染管制', key: 'infection_control', min: rules.min_inf, passKey: 'mandatory_inf' }, { id: 'gen', name: '性別敏感度', key: 'gender_sensitivity', min: rules.min_gen, passKey: 'mandatory_gen' } ]; let mandatoryTotalRaw = results.breakdown.mandatory_total_raw; let mandatoryPassEach = results.passes.mandatory_each_min; mandatoryItems.forEach((item) => { const breakdownItem = results.breakdown.mandatory ? results.breakdown.mandatory[item.key] : null; const rawPoints = breakdownItem ? breakdownItem.value : 0; const pass = results.passes[item.passKey]; html += `<li>${item.name}：${rawPoints.toFixed(1)} ${pass ? '✅' : '❌'}`; if (!pass) { html += `<br><span class="error-reason">【缺少積分】需達到 ${item.min} 分，您目前缺少 ${(item.min - rawPoints).toFixed(1)} 分。</span>`; } html += `</li>`; }); const mandatoryTotalPass = results.passes.mandatory_total; if (!mandatoryTotalPass) { html += `<li class="error-reason sub-item">四大必修合計：${mandatoryTotalRaw.toFixed(1)} ❌<br>【缺少積分】需合計達到 ${rules.min_mandatory_total} 分，您目前缺少 ${(rules.min_mandatory_total - mandatoryTotalRaw).toFixed(1)} 分。</li>`; } if (!mandatoryPassEach) { html += `<li class="error-reason sub-item">四大必修項目 ❌<br>【缺少類別】上述標示 ❌ 的項目未達最低 1 分要求。</li>`; } const culturalBreakdown = results.breakdown.indigenous_multicultural; const preChangeRaw = culturalBreakdown.pre_change_raw; const yearlyTotalRaw = culturalBreakdown.yearly_total_raw; const totalCulturalCounted = culturalBreakdown.counted; const culturalPass = results.passes.indigenous_multicultural; html += `<li>多元文化積分：前=${preChangeRaw.toFixed(1)} + 後=${yearlyTotalRaw.toFixed(1)}（總計 ${totalCulturalCounted.toFixed(1)}） ${culturalPass ? '✅' : '❌'}`; if (!culturalPass) { const totalRequiredCultural = results.notes.includes("新制") ? rules.cultural_after_total_min : rules.cultural_before_min; const culturalDeficit = Math.max(0, totalRequiredCultural - totalCulturalCounted); if (culturalDeficit > 0 || !results.notes.includes("舊制")) { html += `<br><span class="error-reason">【缺少積分】需達到 ${totalRequiredCultural} 分，您目前缺少 ${culturalDeficit.toFixed(1)} 分。</span>`; if (results.notes.includes("新制")) { html += `<br><span class="error-reason"> (新制需每年各 1 分)</span>`; } } else if (results.notes.includes("新制")) { html += `<br><span class="error-reason">【未達標】新制需每年各 1 分，請檢查各年度積分。</span>`; } else if (!results.notes.includes("新制") && !results.notes.includes("舊制")) { html += `<br><span class="error-reason">【錯誤】${results.notes}</span>`; } } html += `</li>`; const onlinePoints = results.breakdown.online_points_raw; const onlineCounted = results.breakdown.online_points_capped; const onlinePass = results.passes.online_max; html += `<li>網路積分：${onlinePoints.toFixed(1)}（計入 ${onlineCounted.toFixed(1)}，上限 ${rules.max_online_points}） ${onlinePass ? '✅' : ''}`; html += `</li>`; const physicalPoints = results.breakdown.physical_points_derived; const physicalPass = results.passes.physical_min; if (!physicalPass) { html += `<li class="error-reason sub-item">實體積分：${physicalPoints.toFixed(1)} ❌<br>【缺少積分】實體積分需達到 ${rules.min_physical_points} 分，您目前缺少 ${(rules.min_physical_points - physicalPoints).toFixed(1)} 分。(總分 - 網路積分)</li>`; } const totalCounted = results.total_counted; const totalPass = results.passes.total; html += `<li>📊 **加總後總積分**（計入上限後）：${totalCounted.toFixed(1)} ${totalPass ? '✅' : '❌'}`; if (!totalPass) { html += `<br><span class="error-reason">【缺少積分】總積分需達到 ${rules.min_total_points} 分，您目前缺少 ${(rules.min_total_points - totalCounted).toFixed(1)} 分。</span>`; } html += `</li>`; html += '</ol>'; detailsDiv.innerHTML = html; console.log("Results displayed."); }
     // --- Initial Setup ---
     document.addEventListener('DOMContentLoaded', () => { const navLinks = document.querySelectorAll('.sub-nav a'); navLinks.forEach(link => { link.addEventListener('click', (e) => { navLinks.forEach(nav => nav.classList.remove('active')); link.classList.add('active'); }); }); console.log("DOM Loaded, event listeners attached."); });
  </script>
</body>
</html>
