<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>é•·ç…§ç©åˆ†å¯©æŸ¥å°å¹«æ‰‹</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <img src="/static/logo.svg" alt="logo" height="60">
    <h1>ğŸ”° å°å¡ç©åˆ†å¯©æŸ¥ç³»çµ± <small>Care Points Helper</small></h1>
  </header>

  <main>
    <section id="input-section">
      <h2>è¼¸å…¥ç©åˆ†è³‡æ–™</h2>

      <div class="input-group">
        <label for="start_minguo">å°å¡ç”Ÿæ•ˆæ—¥æœŸï¼ˆæ°‘åœ‹ YYY-MM-DDï¼‰ï¼š</label>
        <input type="text" id="start_minguo" placeholder="ä¾‹å¦‚ï¼š112-06-02">
        <button onclick="calculateDates()">è¨ˆç®—æ•ˆæœŸ</button>
        <div id="date-display" class="date-info"></div>
      </div>

      <fieldset>
        <legend>ä¸»è¦ç©åˆ†</legend>
        <div class="input-item">
          <label for="prof_course">â–¶ å°ˆæ¥­èª²ç¨‹ç©åˆ†ï¼š</label>
          <input type="number" id="prof_course" value="0">
        </div>
        <div class="input-item">
          <label for="qer_quality">â–¶ å°ˆæ¥­å“è³ªç©åˆ†ï¼š</label>
          <input type="number" id="qer_quality" value="0">
        </div>
        <div class="input-item">
          <label for="qer_ethics">â–¶ å°ˆæ¥­å€«ç†ç©åˆ†ï¼š</label>
          <input type="number" id="qer_ethics" value="0">
        </div>
        <div class="input-item">
          <label for="qer_regulation">â–¶ å°ˆæ¥­æ³•è¦ç©åˆ†ï¼š</label>
          <input type="number" id="qer_regulation" value="0">
        </div>
      </fieldset>

      <fieldset>
        <legend>å››å¤§å¿…ä¿®</legend>
        <div class="input-item">
          <label for="mand_fire">â–¶ æ¶ˆé˜²å®‰å…¨ç©åˆ†ï¼š</label>
          <input type="number" id="mand_fire" value="0">
        </div>
        <div class="input-item">
          <label for="mand_er">â–¶ ç·Šæ€¥æ‡‰è®Šç©åˆ†ï¼š</label>
          <input type="number" id="mand_er" value="0">
        </div>
        <div class="input-item">
          <label for="mand_inf">â–¶ æ„ŸæŸ“ç®¡åˆ¶ç©åˆ†ï¼š</label>
          <input type="number" id="mand_inf" value="0">
        </div>
        <div class="input-item">
          <label for="mand_gen">â–¶ æ€§åˆ¥æ•æ„Ÿåº¦ç©åˆ†ï¼š</label>
          <input type="number" id="mand_gen" value="0">
        </div>
      </fieldset>

      <fieldset>
          <legend>åŸä½æ°‘èˆ‡å¤šå…ƒæ–‡åŒ–ç©åˆ†</legend>
          <div class="input-item">
              <label for="pre_change_cultural">â–¶ 112-06-02 å‰å–å¾—ä¹‹æ–‡åŒ–ç©åˆ†ç¸½åˆ†ï¼š</label>
              <input type="number" id="pre_change_cultural" value="0">
              <small>æ­¤éƒ¨åˆ†æœ€é«˜æ¡è¨ˆ 2 åˆ†</small>
          </div>
          <p>è«‹è¼¸å…¥**å°å¡ç”Ÿæ•ˆå¾Œ**ï¼Œå„å¹´åº¦çš„åŸä½æ°‘æ—æ–‡åŒ– & å¤šå…ƒæ—ç¾¤æ–‡åŒ–ç©åˆ†ï¼ˆ112-06-03 èµ·ï¼Œæ¯å¹´å„éœ€ 1 åˆ†ï¼‰</p>
          <div id="yearly-cultural-inputs">
              <p style="color: grey;">è«‹å…ˆè¼¸å…¥å°å¡ç”Ÿæ•ˆæ—¥æœŸä¸¦é»æ“Šã€Œè¨ˆç®—æ•ˆæœŸã€</p>
          </div>
      </fieldset>

      <fieldset>
        <legend>ç¶²è·¯å­¸ç¿’ç©åˆ†</legend>
        <div class="input-item">
            <label for="online_points">â–¶ ç¶²è·¯å­¸ç¿’ç©åˆ†ç¸½æ•¸ï¼š</label>
            <input type="number" id="online_points" value="0">
            <small>æ‰€æœ‰èª²ç¨‹ä¸­ä¾†è‡ªç¶²è·¯å­¸ç¿’çš„ç©åˆ†åŠ ç¸½ï¼Œä¸Šé™ 40 åˆ†</small>
        </div>
      </fieldset>

      <button onclick="evaluate()">ğŸ” é€å‡ºå¯©æŸ¥</button>

    </section>

    <section id="result-section" style="display: none;">
      <h2>ğŸ” å¯©æŸ¥çµæœï¼š</h2>
      <div id="result-details"></div>
      <pre id="raw-result" style="display:none;"></pre> </section>

    <section id="links-section">
        <h2>ç›¸é—œé€£çµ</h2>
        <ul>
            <li><a href="https://ltcpap.mohw.gov.tw/molc/eg999/index" target="_blank" rel="noopener noreferrer">è¡›ç”Ÿç¦åˆ©éƒ¨é•·ç…§æ©Ÿæ§‹æš¨é•·ç…§äººå“¡ç›¸é—œç®¡ç†è³‡è¨Šç³»çµ± (ç©åˆ†æŸ¥è©¢)</a></li>
            <li><a href="https://1966.gov.tw/LTC/cp-6708-77733-207.html" target="_blank" rel="noopener noreferrer">å„ç¸£å¸‚è¾¦ç†é•·ç…§äººå“¡èªè­‰ã€è£œ/æ›ç™¼ã€æ›´æ–°èªè­‰ç”³è«‹è¯çµ¡è³‡è¨Š</a></li>
        </ul>
        <p><small>æ³¨æ„ï¼šæœ¬å·¥å…·åƒ…ä¾›è©¦ç®—åƒè€ƒï¼Œæœ€çµ‚å¯©æ ¸çµæœè«‹ä»¥ä¸»ç®¡æ©Ÿé—œèªå®šç‚ºæº–ã€‚</small></p>
    </section>
    </main>

  <script>
    // --- Helper Functions ---
    function getNum(id) {
      const el = document.getElementById(id);
      if (!el) return 0;
      const val = parseFloat(el.value);
      return isNaN(val) ? 0 : val;
    }

    function minguoToGregorian(minguoStr) {
        if (!minguoStr || !/^\d{3}-\d{1,2}-\d{1,2}$/.test(minguoStr)) return null;
        try {
            const parts = minguoStr.split('-');
            const year = parseInt(parts[0], 10) + 1911;
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            if (month < 1 || month > 12 || day < 1 || day > 31) return null;
            return new Date(year, month - 1, day);
        } catch (e) {
            console.error("Date conversion error:", e);
            return null;
        }
    }

    function gregorianToMinguo(date) {
        if (!date) return "";
        const year = date.getFullYear() - 1911;
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function addYears(date, years) {
        const newDate = new Date(date);
        newDate.setFullYear(newDate.getFullYear() + years);
        return newDate;
    }

    function subtractMonths(date, months) {
        const newDate = new Date(date);
        newDate.setMonth(newDate.getMonth() - months);
        if (newDate.getDate() < date.getDate()) {
             newDate.setDate(0);
        }
        return newDate;
    }
     function subtractDays(date, days) {
        const newDate = new Date(date);
        newDate.setDate(newDate.getDate() - days);
        return newDate;
    }

    // --- Core Functions ---
    let validityPeriods = [];
    const RULE_CHANGE_DATE_MINGUO = "112-06-02";
    const RULE_CHANGE_DATE = minguoToGregorian(RULE_CHANGE_DATE_MINGUO);

    async function calculateDates() {
        const startMinguo = document.getElementById('start_minguo').value;
        const startDate = minguoToGregorian(startMinguo);
        const displayDiv = document.getElementById('date-display');
        const yearlyInputsDiv = document.getElementById('yearly-cultural-inputs');
        validityPeriods = [];

        if (!startDate) {
            displayDiv.innerHTML = "<p style='color: red;'>æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ YYY-MM-DD</p>";
            yearlyInputsDiv.innerHTML = '<p style="color: grey;">è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„ç”Ÿæ•ˆæ—¥æœŸ</p>';
            return;
        }

        const expiryDate = addYears(startDate, 6);
        const renewalStartDate = subtractMonths(expiryDate, 6);
        const expiryDateMinusOneDay = subtractDays(expiryDate, 1);

        const startDateFormatted = gregorianToMinguo(startDate);
        const expiryDateFormatted = gregorianToMinguo(expiryDateMinusOneDay);
        const renewalStartFormatted = gregorianToMinguo(renewalStartDate);


        displayDiv.innerHTML = `
            <p>ğŸ“… æœ‰æ•ˆæœŸé™ï¼š${startDateFormatted} ~ ${expiryDateFormatted}</p>
            <p>ğŸ“Œ å¯æ›è­‰æ—¥ï¼š${renewalStartFormatted} èµ·</p>
        `;

        yearlyInputsDiv.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const yearStartDate = addYears(startDate, i);
            const yearEndDate = subtractDays(addYears(startDate, i + 1), 1);

            const period = {
                 year: i + 1,
                 start: yearStartDate,
                 end: yearEndDate,
                 startMinguo: gregorianToMinguo(yearStartDate),
                 endMinguo: gregorianToMinguo(yearEndDate)
            };
            validityPeriods.push(period);

            // Check if this *period starts* on or after the rule change date applies
            // If the start date is before, but end date is after, the NEW rule applies for checks within this period.
            // For simplicity, we enable input if the period *ends* after the rule change date,
            // as points might be earned within that year under the new rule.
            // Backend logic should handle exact date checks if needed.
            // Simplified check: If the period ENDS on or after 113-06-03 (the day after the change), assume new rule applies for input.
             const newRuleAppliesForInput = period.end >= addYears(RULE_CHANGE_DATE, 1); // Check if period ENDS after rule change + 1 year (effective year) is cleaner
            // Let's stick to start date logic for simplicity as requested by user's example output format hint
            const isPostChangePeriodStart = period.start >= RULE_CHANGE_DATE;

            // Updated logic based on user example: Hint text changes based on start date vs 112-06-02
            // But yearly inputs seem expected regardless. Let's make inputs always enabled but hint changes.
            const requiredText = isPostChangePeriodStart ? "ï¼ˆæ­¤å¹´åº¦èµ·ï¼Œæ¯å¹´å„éœ€ 1 åˆ†ï¼‰" : "ï¼ˆâš  æ­¤å¹´åº¦ç©åˆ†è¨ˆå…¥ä¸Šæ–¹ 112-06-02 å‰ç¸½åˆ†ï¼Œæœ€å¤šè¨ˆç®—2åˆ†ï¼‰"; // Hint based on period start
            const defaultValue = 0; // Default all to 0

            const yearDiv = document.createElement('div');
            yearDiv.classList.add('yearly-input-group');
            yearDiv.innerHTML = `
                <h4>ç¬¬${period.year}å¹´ï¼š${period.startMinguo} ~ ${period.endMinguo} <small>${requiredText}</small></h4>
                <div class="input-item yearly-item">
                    <label for="year_${period.year}_ind">â–¶ åŸä½æ°‘æ—æ–‡åŒ–ç©åˆ†ï¼š</label>
                    <input type="number" id="year_${period.year}_ind" value="${defaultValue}" min="0">
                </div>
                <div class="input-item yearly-item">
                    <label for="year_${period.year}_mul">â–¶ å¤šå…ƒæ—ç¾¤æ–‡åŒ–ç©åˆ†ï¼š</label>
                    <input type="number" id="year_${period.year}_mul" value="${defaultValue}" min="0">
                </div>
            `;
            yearlyInputsDiv.appendChild(yearDiv);
        }
    }

    async function evaluate() {
        const startDate = minguoToGregorian(document.getElementById('start_minguo').value);
         if (!startDate || validityPeriods.length !== 6) {
             alert("è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„å°å¡ç”Ÿæ•ˆæ—¥æœŸä¸¦é»æ“Šã€Œè¨ˆç®—æ•ˆæœŸã€ã€‚");
             return;
         }

         // Collect yearly cultural points
         const yearlyCulturalPoints = validityPeriods.map(period => {
              return {
                 year: period.year,
                 indigenous: getNum(`year_${period.year}_ind`),
                 multicultural: getNum(`year_${period.year}_mul`),
                 // Add period info for backend if needed later
                 // start_date: period.start.toISOString().split('T')[0],
                 // end_date: period.end.toISOString().split('T')[0]
             };
         });


        const payload = {
          professional_course: getNum('prof_course'),
          quality_ethics_regulation: getNum('qer_quality') + getNum('qer_ethics') + getNum('qer_regulation'),
          quality_points_raw: getNum('qer_quality'),
          ethics_points_raw: getNum('qer_ethics'),
          regulation_points_raw: getNum('qer_regulation'),
          mandatory: {
            fire_safety: getNum('mand_fire'),
            emergency_response: getNum('mand_er'),
            infection_control: getNum('mand_inf'),
            gender_sensitivity: getNum('mand_gen')
          },
           pre_change_cultural_points: getNum('pre_change_cultural'),
           yearly_cultural_points: yearlyCulturalPoints,
           renewal_date: gregorianToMinguo(subtractDays(addYears(startDate, 6), 1)),
           online_points: getNum('online_points')
        };

        payload.fire_safety_raw = payload.mandatory.fire_safety;
        payload.emergency_response_raw = payload.mandatory.emergency_response;
        payload.infection_control_raw = payload.mandatory.infection_control;
        payload.gender_sensitivity_raw = payload.mandatory.gender_sensitivity;


        const resultSection = document.getElementById('result-section');
        const resultDetailsDiv = document.getElementById('result-details');
        const rawResultPre = document.getElementById('raw-result');
        resultDetailsDiv.innerHTML = '<p>è¨ˆç®—ä¸­...</p>';
        resultSection.style.display = 'block';

        try {
            const res = await fetch('/api/evaluate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            rawResultPre.textContent = JSON.stringify(data, null, 2);

            if (res.ok) {
                displayResults(payload, data);
            } else {
                resultDetailsDiv.innerHTML = `<p style="color: red;">å¯©æŸ¥å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
            }
        } catch (e) {
            resultDetailsDiv.innerHTML = `<p style="color: red;">é€£ç·šéŒ¯èª¤: ${e.message}</p>`;
        }
    }

    // --- Display Function ---
    function displayResults(inputs, results) {
         const detailsDiv = document.getElementById('result-details');
         let html = '<ol>';
         const rules = { // Simplified rules
              min_total_points: 120, min_professional_course: 84,
              min_qer_total: 24, max_qer_total: 36,
              min_mandatory_total: 10, min_fire: 1, min_er: 1, min_inf: 1, min_gen: 1,
              cultural_change_date: RULE_CHANGE_DATE_MINGUO,
              cultural_before_min: 2, cultural_before_max: 2,
              cultural_after_yearly_min: 1, cultural_after_total_min: 12, // User example implies 12 total needed
              max_online_points: 40, min_physical_points: 80
         };

         // 1. Professional Course
         const profPoints = inputs.professional_course;
         const profPass = results.passes.professional_min;
         html += `<li>å°ˆæ¥­èª²ç¨‹ç©åˆ†ï¼š${profPoints.toFixed(1)} ${profPass ? 'âœ…' : 'âŒ'}`;
         if (!profPass) { html += `<br><span class="error-reason">ã€ç¼ºå°‘ç©åˆ†ã€‘éœ€é”åˆ° ${rules.min_professional_course} åˆ†ï¼Œæ‚¨ç›®å‰ç¼ºå°‘ ${(rules.min_professional_course - profPoints).toFixed(1)} åˆ†ã€‚</span>`; }
         html += `</li>`;

         // 2. Total Points (defer check)

         // 3. QER
         const qerRawTotal = inputs.quality_points_raw + inputs.ethics_points_raw + inputs.regulation_points_raw;
         const qerCounted = results.breakdown.quality_ethics_regulation.counted;
         const qerPassMin = results.passes.qer_min;
         const qerPassEachNonZero = results.passes.qer_each_non_zero;
         const qerPass = qerPassMin && qerPassEachNonZero;
         html += `<li>å“è³ª/å€«ç†/æ³•è¦ç©åˆ†ï¼š${qerRawTotal.toFixed(1)}ï¼ˆè¨ˆå…¥ ${qerCounted.toFixed(1)}ï¼Œä¸Šé™ ${rules.max_qer_total}ï¼‰ ${qerPass ? 'âœ…' : 'âŒ'}`;
         if (!qerPassMin) { html += `<br><span class="error-reason">ã€ç¼ºå°‘ç©åˆ†ã€‘åˆè¨ˆéœ€é”åˆ° ${rules.min_qer_total} åˆ†ï¼Œæ‚¨ç›®å‰ç¼ºå°‘ ${(rules.min_qer_total - qerCounted).toFixed(1)} åˆ†ã€‚</span>`; }
         if (!qerPassEachNonZero) {
              let missingCats = [];
              if (inputs.quality_points_raw <= 0) missingCats.push("å“è³ª");
              if (inputs.ethics_points_raw <= 0) missingCats.push("å€«ç†");
              if (inputs.regulation_points_raw <= 0) missingCats.push("æ³•è¦");
              html += `<br><span class="error-reason">ã€ç¼ºå°‘é¡åˆ¥ã€‘${missingCats.join('ã€')} ä¸å¯ç‚º 0 åˆ†ã€‚</span>`;
         }
         html += `</li>`;

         // 4, 5, 6, 7. Mandatory Courses
         const mandatoryItems = [
            { id: 'fire', name: 'æ¶ˆé˜²å®‰å…¨', key: 'fire_safety', min: rules.min_fire, passKey: 'mandatory_fire' },
            { id: 'er', name: 'ç·Šæ€¥æ‡‰è®Š', key: 'emergency_response', min: rules.min_er, passKey: 'mandatory_er' },
            { id: 'inf', name: 'æ„ŸæŸ“ç®¡åˆ¶', key: 'infection_control', min: rules.min_inf, passKey: 'mandatory_inf' },
            { id: 'gen', name: 'æ€§åˆ¥æ•æ„Ÿåº¦', key: 'gender_sensitivity', min: rules.min_gen, passKey: 'mandatory_gen' }
         ];
         let mandatoryTotalRaw = results.breakdown.mandatory_total_raw; // Get from backend
         let mandatoryPassEach = results.passes.mandatory_each_min; // Get from backend
         mandatoryItems.forEach((item, index) => {
             const rawPoints = results.breakdown.mandatory[item.key].value; // Get from backend breakdown
             const pass = results.passes[item.passKey]; // Get pass status from backend
             html += `<li>${item.name}ï¼š${rawPoints.toFixed(1)} ${pass ? 'âœ…' : 'âŒ'}`;
             if (!pass) { html += `<br><span class="error-reason">ã€ç¼ºå°‘ç©åˆ†ã€‘éœ€é”åˆ° ${item.min} åˆ†ï¼Œæ‚¨ç›®å‰ç¼ºå°‘ ${(item.min - rawPoints).toFixed(1)} åˆ†ã€‚</span>`; }
             html += `</li>`;
         });

        const mandatoryTotalPass = results.passes.mandatory_total;
        if (!mandatoryTotalPass) { html += `<li class="error-reason sub-item">å››å¤§å¿…ä¿®åˆè¨ˆï¼š${mandatoryTotalRaw.toFixed(1)} âŒ<br>ã€ç¼ºå°‘ç©åˆ†ã€‘éœ€åˆè¨ˆé”åˆ° ${rules.min_mandatory_total} åˆ†ï¼Œæ‚¨ç›®å‰ç¼ºå°‘ ${(rules.min_mandatory_total - mandatoryTotalRaw).toFixed(1)} åˆ†ã€‚</li>`; }
         if (!mandatoryPassEach) { html += `<li class="error-reason sub-item">å››å¤§å¿…ä¿®é …ç›® âŒ<br>ã€ç¼ºå°‘é¡åˆ¥ã€‘ä¸Šè¿°æ¨™ç¤º âŒ çš„é …ç›®ä¸å¯ç‚º 0 åˆ†ã€‚</li>`; }


         // 8. Cultural Points (Based on User Example format)
         const culturalBreakdown = results.breakdown.indigenous_multicultural;
         const preChangeRaw = culturalBreakdown.pre_change_raw;
         const preChangeCounted = culturalBreakdown.pre_change_counted; // From backend
         const yearlyTotalRaw = culturalBreakdown.yearly_total_raw; // From backend
         const totalCulturalCounted = culturalBreakdown.counted; // Final counted from backend
         const culturalPass = results.passes.indigenous_multicultural; // Overall pass from backend

         // Adjust display based on user example: separate pre/post, show total counted
         html += `<li>å¤šå…ƒæ–‡åŒ–ç©åˆ†ï¼šå‰=${preChangeRaw.toFixed(1)} + å¾Œ=${yearlyTotalRaw.toFixed(1)}ï¼ˆç¸½è¨ˆ ${totalCulturalCounted.toFixed(1)}ï¼‰ ${culturalPass ? 'âœ…' : 'âŒ'}`;

         if (!culturalPass) {
             // User example expects a total requirement of 12 for failure message
             const totalRequiredCultural = results.notes.includes("æ–°åˆ¶") ? rules.cultural_after_total_min : rules.cultural_before_min;
             const culturalDeficit = totalRequiredCultural - totalCulturalCounted;
             if (culturalDeficit > 0) {
                  html += `<br><span class="error-reason">ã€ç¼ºå°‘ç©åˆ†ã€‘éœ€é”åˆ° ${totalRequiredCultural} åˆ†ï¼Œæ‚¨ç›®å‰ç¼ºå°‘ ${culturalDeficit.toFixed(1)} åˆ†ã€‚</span>`;
                  if (results.notes.includes("æ–°åˆ¶")) {
                       html += `<br><span class="error-reason"> (æ–°åˆ¶éœ€æ¯å¹´å„ 1 åˆ†)</span>`;
                  }
             } else if (results.notes.includes("æ–°åˆ¶")) {
                  // If total is met but yearly fails (edge case)
                   html += `<br><span class="error-reason">ã€æœªé”æ¨™ã€‘æ–°åˆ¶éœ€æ¯å¹´å„ 1 åˆ†ï¼Œè«‹æª¢æŸ¥å„å¹´åº¦ç©åˆ†ã€‚</span>`;
             } else if (!results.notes.includes("æ–°åˆ¶") && !results.notes.includes("èˆŠåˆ¶")) {
                  html += `<br><span class="error-reason">ã€éŒ¯èª¤ã€‘${results.notes}</span>`; // Show backend note if unknown state
             }
         }
         html += `</li>`;

         // 9. Online Points
         const onlinePoints = results.breakdown.online_points_raw;
         const onlineCounted = results.breakdown.online_points_capped;
         const onlinePass = results.passes.online_max;
         html += `<li>ç¶²è·¯ç©åˆ†ï¼š${onlinePoints.toFixed(1)}ï¼ˆè¨ˆå…¥ ${onlineCounted.toFixed(1)}ï¼Œä¸Šé™ ${rules.max_online_points}ï¼‰ ${onlinePass ? 'âœ…' : ''}`; // No explicit fail needed, just cap info
         // The real check is physical points
         html += `</li>`;

         // Physical points check (derived)
         const physicalPoints = results.breakdown.physical_points_derived;
         const physicalPass = results.passes.physical_min;
           if (!physicalPass) {
                html += `<li class="error-reason sub-item">å¯¦é«”ç©åˆ†ï¼š${physicalPoints.toFixed(1)} âŒ<br>ã€ç¼ºå°‘ç©åˆ†ã€‘å¯¦é«”ç©åˆ†éœ€é”åˆ° ${rules.min_physical_points} åˆ†ï¼Œæ‚¨ç›®å‰ç¼ºå°‘ ${(rules.min_physical_points - physicalPoints).toFixed(1)} åˆ†ã€‚(ç¸½åˆ† - ç¶²è·¯ç©åˆ†)</li>`;
           }

         // 2. Total Points (Final Check) - Use total calculated by backend
         const totalCounted = results.total_counted;
         const totalPass = results.passes.total;
         html += `<li>ğŸ“Š **åŠ ç¸½å¾Œç¸½ç©åˆ†**ï¼ˆè¨ˆå…¥ä¸Šé™å¾Œï¼‰ï¼š${totalCounted.toFixed(1)} ${totalPass ? 'âœ…' : 'âŒ'}`;
         if (!totalPass) { html += `<br><span class="error-reason">ã€ç¼ºå°‘ç©åˆ†ã€‘ç¸½ç©åˆ†éœ€é”åˆ° ${rules.min_total_points} åˆ†ï¼Œæ‚¨ç›®å‰ç¼ºå°‘ ${(rules.min_total_points - totalCounted).toFixed(1)} åˆ†ã€‚</span>`; }
         html += `</li>`;

         html += '</ol>';
         detailsDiv.innerHTML = html;
     }

  </script>
</body>
</html>
