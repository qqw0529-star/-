<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>長照積分審查小幫手</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <img src="/static/logo.svg" alt="logo" height="60">
    <h1>🔰 小卡積分審查系統 <small>Care Points Helper</small></h1>
  </header>

  <main>
    <section id="input-section">
      <h2>輸入積分資料</h2>

      <div class="input-group">
        <label for="start_minguo">小卡生效日期（民國 YYY-MM-DD）：</label>
        <input type="text" id="start_minguo" placeholder="例如：112-06-02">
        <button onclick="calculateDates()">計算效期</button>
        <div id="date-display" class="date-info"></div>
      </div>

      <fieldset>
        <legend>主要積分</legend>
        <div class="input-item">
          <label for="prof_course">▶ 專業課程積分：</label>
          <input type="number" id="prof_course" value="0">
        </div>
        <div class="input-item">
          <label for="qer_quality">▶ 專業品質積分：</label>
          <input type="number" id="qer_quality" value="0">
        </div>
        <div class="input-item">
          <label for="qer_ethics">▶ 專業倫理積分：</label>
          <input type="number" id="qer_ethics" value="0">
        </div>
        <div class="input-item">
          <label for="qer_regulation">▶ 專業法規積分：</label>
          <input type="number" id="qer_regulation" value="0">
        </div>
      </fieldset>

      <fieldset>
        <legend>四大必修</legend>
        <div class="input-item">
          <label for="mand_fire">▶ 消防安全積分：</label>
          <input type="number" id="mand_fire" value="0">
        </div>
        <div class="input-item">
          <label for="mand_er">▶ 緊急應變積分：</label>
          <input type="number" id="mand_er" value="0">
        </div>
        <div class="input-item">
          <label for="mand_inf">▶ 感染管制積分：</label>
          <input type="number" id="mand_inf" value="0">
        </div>
        <div class="input-item">
          <label for="mand_gen">▶ 性別敏感度積分：</label>
          <input type="number" id="mand_gen" value="0">
        </div>
      </fieldset>

      <fieldset>
          <legend>原住民與多元文化積分</legend>
          <div class="input-item">
              <label for="pre_change_cultural">▶ 112-06-02 前取得之文化積分總分：</label>
              <input type="number" id="pre_change_cultural" value="0">
              <small>此部分最高採計 2 分</small>
          </div>
          <p>請輸入**小卡生效後**，各年度的原住民族文化 & 多元族群文化積分（112-06-03 起，每年各需 1 分）</p>
          <div id="yearly-cultural-inputs">
              <p style="color: grey;">請先輸入小卡生效日期並點擊「計算效期」</p>
          </div>
      </fieldset>

      <fieldset>
        <legend>網路學習積分</legend>
        <div class="input-item">
            <label for="online_points">▶ 網路學習積分總數：</label>
            <input type="number" id="online_points" value="0">
            <small>所有課程中來自網路學習的積分加總，上限 40 分</small>
        </div>
      </fieldset>

      <button onclick="evaluate()">🔍 送出審查</button>

    </section>

    <section id="result-section" style="display: none;">
      <h2>🔍 審查結果：</h2>
      <div id="result-details"></div>
      <pre id="raw-result" style="display:none;"></pre> </section>

    <section id="links-section">
        <h2>相關連結</h2>
        <ul>
            <li><a href="https://ltcpap.mohw.gov.tw/molc/eg999/index" target="_blank" rel="noopener noreferrer">衛生福利部長照機構暨長照人員相關管理資訊系統 (積分查詢)</a></li>
            <li><a href="https://1966.gov.tw/LTC/cp-6708-77733-207.html" target="_blank" rel="noopener noreferrer">各縣市辦理長照人員認證、補/換發、更新認證申請聯絡資訊</a></li>
        </ul>
        <p><small>注意：本工具僅供試算參考，最終審核結果請以主管機關認定為準。</small></p>
    </section>
    </main>

  <script>
    // --- Helper Functions ---
    function getNum(id) {
      const el = document.getElementById(id);
      if (!el) return 0;
      const val = parseFloat(el.value);
      return isNaN(val) ? 0 : val;
    }

    function minguoToGregorian(minguoStr) {
        if (!minguoStr || !/^\d{3}-\d{1,2}-\d{1,2}$/.test(minguoStr)) return null;
        try {
            const parts = minguoStr.split('-');
            const year = parseInt(parts[0], 10) + 1911;
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            if (month < 1 || month > 12 || day < 1 || day > 31) return null;
            return new Date(year, month - 1, day);
        } catch (e) {
            console.error("Date conversion error:", e);
            return null;
        }
    }

    function gregorianToMinguo(date) {
        if (!date) return "";
        const year = date.getFullYear() - 1911;
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function addYears(date, years) {
        const newDate = new Date(date);
        newDate.setFullYear(newDate.getFullYear() + years);
        return newDate;
    }

    function subtractMonths(date, months) {
        const newDate = new Date(date);
        newDate.setMonth(newDate.getMonth() - months);
        if (newDate.getDate() < date.getDate()) {
             newDate.setDate(0);
        }
        return newDate;
    }
     function subtractDays(date, days) {
        const newDate = new Date(date);
        newDate.setDate(newDate.getDate() - days);
        return newDate;
    }

    // --- Core Functions ---
    let validityPeriods = [];
    const RULE_CHANGE_DATE_MINGUO = "112-06-02";
    const RULE_CHANGE_DATE = minguoToGregorian(RULE_CHANGE_DATE_MINGUO);

    async function calculateDates() {
        const startMinguo = document.getElementById('start_minguo').value;
        const startDate = minguoToGregorian(startMinguo);
        const displayDiv = document.getElementById('date-display');
        const yearlyInputsDiv = document.getElementById('yearly-cultural-inputs');
        validityPeriods = [];

        if (!startDate) {
            displayDiv.innerHTML = "<p style='color: red;'>日期格式錯誤，請使用 YYY-MM-DD</p>";
            yearlyInputsDiv.innerHTML = '<p style="color: grey;">請先輸入有效的生效日期</p>';
            return;
        }

        const expiryDate = addYears(startDate, 6);
        const renewalStartDate = subtractMonths(expiryDate, 6);
        const expiryDateMinusOneDay = subtractDays(expiryDate, 1);

        const startDateFormatted = gregorianToMinguo(startDate);
        const expiryDateFormatted = gregorianToMinguo(expiryDateMinusOneDay);
        const renewalStartFormatted = gregorianToMinguo(renewalStartDate);


        displayDiv.innerHTML = `
            <p>📅 有效期限：${startDateFormatted} ~ ${expiryDateFormatted}</p>
            <p>📌 可換證日：${renewalStartFormatted} 起</p>
        `;

        yearlyInputsDiv.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const yearStartDate = addYears(startDate, i);
            const yearEndDate = subtractDays(addYears(startDate, i + 1), 1);

            const period = {
                 year: i + 1,
                 start: yearStartDate,
                 end: yearEndDate,
                 startMinguo: gregorianToMinguo(yearStartDate),
                 endMinguo: gregorianToMinguo(yearEndDate)
            };
            validityPeriods.push(period);

            // Check if this *period starts* on or after the rule change date applies
            // If the start date is before, but end date is after, the NEW rule applies for checks within this period.
            // For simplicity, we enable input if the period *ends* after the rule change date,
            // as points might be earned within that year under the new rule.
            // Backend logic should handle exact date checks if needed.
            // Simplified check: If the period ENDS on or after 113-06-03 (the day after the change), assume new rule applies for input.
             const newRuleAppliesForInput = period.end >= addYears(RULE_CHANGE_DATE, 1); // Check if period ENDS after rule change + 1 year (effective year) is cleaner
            // Let's stick to start date logic for simplicity as requested by user's example output format hint
            const isPostChangePeriodStart = period.start >= RULE_CHANGE_DATE;

            // Updated logic based on user example: Hint text changes based on start date vs 112-06-02
            // But yearly inputs seem expected regardless. Let's make inputs always enabled but hint changes.
            const requiredText = isPostChangePeriodStart ? "（此年度起，每年各需 1 分）" : "（⚠ 此年度積分計入上方 112-06-02 前總分，最多計算2分）"; // Hint based on period start
            const defaultValue = 0; // Default all to 0

            const yearDiv = document.createElement('div');
            yearDiv.classList.add('yearly-input-group');
            yearDiv.innerHTML = `
                <h4>第${period.year}年：${period.startMinguo} ~ ${period.endMinguo} <small>${requiredText}</small></h4>
                <div class="input-item yearly-item">
                    <label for="year_${period.year}_ind">▶ 原住民族文化積分：</label>
                    <input type="number" id="year_${period.year}_ind" value="${defaultValue}" min="0">
                </div>
                <div class="input-item yearly-item">
                    <label for="year_${period.year}_mul">▶ 多元族群文化積分：</label>
                    <input type="number" id="year_${period.year}_mul" value="${defaultValue}" min="0">
                </div>
            `;
            yearlyInputsDiv.appendChild(yearDiv);
        }
    }

    async function evaluate() {
        const startDate = minguoToGregorian(document.getElementById('start_minguo').value);
         if (!startDate || validityPeriods.length !== 6) {
             alert("請先輸入有效的小卡生效日期並點擊「計算效期」。");
             return;
         }

         // Collect yearly cultural points
         const yearlyCulturalPoints = validityPeriods.map(period => {
              return {
                 year: period.year,
                 indigenous: getNum(`year_${period.year}_ind`),
                 multicultural: getNum(`year_${period.year}_mul`),
                 // Add period info for backend if needed later
                 // start_date: period.start.toISOString().split('T')[0],
                 // end_date: period.end.toISOString().split('T')[0]
             };
         });


        const payload = {
          professional_course: getNum('prof_course'),
          quality_ethics_regulation: getNum('qer_quality') + getNum('qer_ethics') + getNum('qer_regulation'),
          quality_points_raw: getNum('qer_quality'),
          ethics_points_raw: getNum('qer_ethics'),
          regulation_points_raw: getNum('qer_regulation'),
          mandatory: {
            fire_safety: getNum('mand_fire'),
            emergency_response: getNum('mand_er'),
            infection_control: getNum('mand_inf'),
            gender_sensitivity: getNum('mand_gen')
          },
           pre_change_cultural_points: getNum('pre_change_cultural'),
           yearly_cultural_points: yearlyCulturalPoints,
           renewal_date: gregorianToMinguo(subtractDays(addYears(startDate, 6), 1)),
           online_points: getNum('online_points')
        };

        payload.fire_safety_raw = payload.mandatory.fire_safety;
        payload.emergency_response_raw = payload.mandatory.emergency_response;
        payload.infection_control_raw = payload.mandatory.infection_control;
        payload.gender_sensitivity_raw = payload.mandatory.gender_sensitivity;


        const resultSection = document.getElementById('result-section');
        const resultDetailsDiv = document.getElementById('result-details');
        const rawResultPre = document.getElementById('raw-result');
        resultDetailsDiv.innerHTML = '<p>計算中...</p>';
        resultSection.style.display = 'block';

        try {
            const res = await fetch('/api/evaluate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            rawResultPre.textContent = JSON.stringify(data, null, 2);

            if (res.ok) {
                displayResults(payload, data);
            } else {
                resultDetailsDiv.innerHTML = `<p style="color: red;">審查失敗: ${data.error || '未知錯誤'}</p>`;
            }
        } catch (e) {
            resultDetailsDiv.innerHTML = `<p style="color: red;">連線錯誤: ${e.message}</p>`;
        }
    }

    // --- Display Function ---
    function displayResults(inputs, results) {
         const detailsDiv = document.getElementById('result-details');
         let html = '<ol>';
         const rules = { // Simplified rules
              min_total_points: 120, min_professional_course: 84,
              min_qer_total: 24, max_qer_total: 36,
              min_mandatory_total: 10, min_fire: 1, min_er: 1, min_inf: 1, min_gen: 1,
              cultural_change_date: RULE_CHANGE_DATE_MINGUO,
              cultural_before_min: 2, cultural_before_max: 2,
              cultural_after_yearly_min: 1, cultural_after_total_min: 12, // User example implies 12 total needed
              max_online_points: 40, min_physical_points: 80
         };

         // 1. Professional Course
         const profPoints = inputs.professional_course;
         const profPass = results.passes.professional_min;
         html += `<li>專業課程積分：${profPoints.toFixed(1)} ${profPass ? '✅' : '❌'}`;
         if (!profPass) { html += `<br><span class="error-reason">【缺少積分】需達到 ${rules.min_professional_course} 分，您目前缺少 ${(rules.min_professional_course - profPoints).toFixed(1)} 分。</span>`; }
         html += `</li>`;

         // 2. Total Points (defer check)

         // 3. QER
         const qerRawTotal = inputs.quality_points_raw + inputs.ethics_points_raw + inputs.regulation_points_raw;
         const qerCounted = results.breakdown.quality_ethics_regulation.counted;
         const qerPassMin = results.passes.qer_min;
         const qerPassEachNonZero = results.passes.qer_each_non_zero;
         const qerPass = qerPassMin && qerPassEachNonZero;
         html += `<li>品質/倫理/法規積分：${qerRawTotal.toFixed(1)}（計入 ${qerCounted.toFixed(1)}，上限 ${rules.max_qer_total}） ${qerPass ? '✅' : '❌'}`;
         if (!qerPassMin) { html += `<br><span class="error-reason">【缺少積分】合計需達到 ${rules.min_qer_total} 分，您目前缺少 ${(rules.min_qer_total - qerCounted).toFixed(1)} 分。</span>`; }
         if (!qerPassEachNonZero) {
              let missingCats = [];
              if (inputs.quality_points_raw <= 0) missingCats.push("品質");
              if (inputs.ethics_points_raw <= 0) missingCats.push("倫理");
              if (inputs.regulation_points_raw <= 0) missingCats.push("法規");
              html += `<br><span class="error-reason">【缺少類別】${missingCats.join('、')} 不可為 0 分。</span>`;
         }
         html += `</li>`;

         // 4, 5, 6, 7. Mandatory Courses
         const mandatoryItems = [
            { id: 'fire', name: '消防安全', key: 'fire_safety', min: rules.min_fire, passKey: 'mandatory_fire' },
            { id: 'er', name: '緊急應變', key: 'emergency_response', min: rules.min_er, passKey: 'mandatory_er' },
            { id: 'inf', name: '感染管制', key: 'infection_control', min: rules.min_inf, passKey: 'mandatory_inf' },
            { id: 'gen', name: '性別敏感度', key: 'gender_sensitivity', min: rules.min_gen, passKey: 'mandatory_gen' }
         ];
         let mandatoryTotalRaw = results.breakdown.mandatory_total_raw; // Get from backend
         let mandatoryPassEach = results.passes.mandatory_each_min; // Get from backend
         mandatoryItems.forEach((item, index) => {
             const rawPoints = results.breakdown.mandatory[item.key].value; // Get from backend breakdown
             const pass = results.passes[item.passKey]; // Get pass status from backend
             html += `<li>${item.name}：${rawPoints.toFixed(1)} ${pass ? '✅' : '❌'}`;
             if (!pass) { html += `<br><span class="error-reason">【缺少積分】需達到 ${item.min} 分，您目前缺少 ${(item.min - rawPoints).toFixed(1)} 分。</span>`; }
             html += `</li>`;
         });

        const mandatoryTotalPass = results.passes.mandatory_total;
        if (!mandatoryTotalPass) { html += `<li class="error-reason sub-item">四大必修合計：${mandatoryTotalRaw.toFixed(1)} ❌<br>【缺少積分】需合計達到 ${rules.min_mandatory_total} 分，您目前缺少 ${(rules.min_mandatory_total - mandatoryTotalRaw).toFixed(1)} 分。</li>`; }
         if (!mandatoryPassEach) { html += `<li class="error-reason sub-item">四大必修項目 ❌<br>【缺少類別】上述標示 ❌ 的項目不可為 0 分。</li>`; }


         // 8. Cultural Points (Based on User Example format)
         const culturalBreakdown = results.breakdown.indigenous_multicultural;
         const preChangeRaw = culturalBreakdown.pre_change_raw;
         const preChangeCounted = culturalBreakdown.pre_change_counted; // From backend
         const yearlyTotalRaw = culturalBreakdown.yearly_total_raw; // From backend
         const totalCulturalCounted = culturalBreakdown.counted; // Final counted from backend
         const culturalPass = results.passes.indigenous_multicultural; // Overall pass from backend

         // Adjust display based on user example: separate pre/post, show total counted
         html += `<li>多元文化積分：前=${preChangeRaw.toFixed(1)} + 後=${yearlyTotalRaw.toFixed(1)}（總計 ${totalCulturalCounted.toFixed(1)}） ${culturalPass ? '✅' : '❌'}`;

         if (!culturalPass) {
             // User example expects a total requirement of 12 for failure message
             const totalRequiredCultural = results.notes.includes("新制") ? rules.cultural_after_total_min : rules.cultural_before_min;
             const culturalDeficit = totalRequiredCultural - totalCulturalCounted;
             if (culturalDeficit > 0) {
                  html += `<br><span class="error-reason">【缺少積分】需達到 ${totalRequiredCultural} 分，您目前缺少 ${culturalDeficit.toFixed(1)} 分。</span>`;
                  if (results.notes.includes("新制")) {
                       html += `<br><span class="error-reason"> (新制需每年各 1 分)</span>`;
                  }
             } else if (results.notes.includes("新制")) {
                  // If total is met but yearly fails (edge case)
                   html += `<br><span class="error-reason">【未達標】新制需每年各 1 分，請檢查各年度積分。</span>`;
             } else if (!results.notes.includes("新制") && !results.notes.includes("舊制")) {
                  html += `<br><span class="error-reason">【錯誤】${results.notes}</span>`; // Show backend note if unknown state
             }
         }
         html += `</li>`;

         // 9. Online Points
         const onlinePoints = results.breakdown.online_points_raw;
         const onlineCounted = results.breakdown.online_points_capped;
         const onlinePass = results.passes.online_max;
         html += `<li>網路積分：${onlinePoints.toFixed(1)}（計入 ${onlineCounted.toFixed(1)}，上限 ${rules.max_online_points}） ${onlinePass ? '✅' : ''}`; // No explicit fail needed, just cap info
         // The real check is physical points
         html += `</li>`;

         // Physical points check (derived)
         const physicalPoints = results.breakdown.physical_points_derived;
         const physicalPass = results.passes.physical_min;
           if (!physicalPass) {
                html += `<li class="error-reason sub-item">實體積分：${physicalPoints.toFixed(1)} ❌<br>【缺少積分】實體積分需達到 ${rules.min_physical_points} 分，您目前缺少 ${(rules.min_physical_points - physicalPoints).toFixed(1)} 分。(總分 - 網路積分)</li>`;
           }

         // 2. Total Points (Final Check) - Use total calculated by backend
         const totalCounted = results.total_counted;
         const totalPass = results.passes.total;
         html += `<li>📊 **加總後總積分**（計入上限後）：${totalCounted.toFixed(1)} ${totalPass ? '✅' : '❌'}`;
         if (!totalPass) { html += `<br><span class="error-reason">【缺少積分】總積分需達到 ${rules.min_total_points} 分，您目前缺少 ${(rules.min_total_points - totalCounted).toFixed(1)} 分。</span>`; }
         html += `</li>`;

         html += '</ol>';
         detailsDiv.innerHTML = html;
     }

  </script>
</body>
</html>
